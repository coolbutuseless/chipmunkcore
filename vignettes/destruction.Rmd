---
title: "Inevitable Destruction"
output: html_document
vignette: >
  %\VignetteIndexEntry{Inevitable Destruction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>"
)


library(chipmunkcore)
library(ggplot2)
```


## Boxes example


```{r setup}
library(chipmunkcore)
library(ggplot2)
set.seed(1)

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Initialize a simulation space
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
cm <- Chipmunk$new()

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Add fixed segments for the ground
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
cm$add_static_segment(-70, 0, 70, 0)

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Fetch all the segments. Use for plotting
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
segments_df <- cm$get_static_segments()

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Stack boxes
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
cm$add_box(x = 0, y =  5, width = 2, height = 2 * 5)
cm$add_box(x = 4, y =  5, width = 2, height = 2 * 5)
cm$add_box(x = 2, y = 11, width = 6, height = 2 * 1)

cm$add_box(x = 0, y = 17, width = 2, height = 2 * 5)
cm$add_box(x = 4, y = 17, width = 2, height = 2 * 5)
cm$add_box(x = 2, y = 23, width = 6, height = 2 * 1)

cm$add_box(x = 0, y = 29, width = 2, height = 2 * 5)
cm$add_box(x = 4, y = 29, width = 2, height = 2 * 5)
cm$add_box(x = 2, y = 35, width = 6, height = 2 * 1)

cm$add_box(x = 0, y = 41, width = 2, height = 2 * 5)
cm$add_box(x = 4, y = 41, width = 2, height = 2 * 5)
cm$add_box(x = 2, y = 47, width = 6, height = 2 * 1)


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Bowling ball
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
cm$add_circle(x = -40, y = 8, radius = 8, vx = 50, mass = 100, friction = 0.2)

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Get the boxes as a list of vertices. This is ideal for 
# ggplot::geom_polygon()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
boxes <- cm$get_boxes_as_polygons()
bball <- cm$get_circles()

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Plot everything
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ggplot() + 
  geom_polygon(data = boxes, aes(x, y, group = idx, fill = as.factor(idx))) + 
  geom_point(data = bball, aes(x, y), size = 35) + 
  geom_segment(data = segments_df, aes(x = x1, y = y1, xend = x2, yend = y2)) + 
  coord_fixed(xlim = c(-50, 50), ylim = c(0, 50)) +
  theme_void() + 
  theme(legend.position = 'none')
```


## Full animation


```{r eval=FALSE, echo=FALSE}

unlink(list.files("vignettes/png", "*.png", full.names = TRUE))

for (i in seq_len(200)) {
  cm$advance(4)
  
  if (i %% 10 == 0) message(i)
  
  boxes <- cm$get_boxes_as_polygons()
  bball <- cm$get_circles()
  
  p <- ggplot() + 
    geom_polygon(data = boxes, aes(x, y, group = idx, fill = as.factor(idx))) + 
    geom_point(data = bball, aes(x, y), size = 30) + 
    geom_segment(data = segments_df, aes(x = x1, y = y1, xend = x2, yend = y2)) + 
    theme_minimal() + 
    theme(legend.position = 'none') + 
    coord_fixed(xlim = c(-50, 50), ylim = c(0, 50)) 
  
  outfile <- sprintf("vignettes/png/%04i.png", i)
  ggsave(outfile, p, width = 7, height = 7)
}

system("ffmpeg -y -framerate 30 -pattern_type glob -i 'vignettes/png/*.png' -c:v libx264 -pix_fmt yuv420p -s 800x800 vignettes/anim/inevitable.mp4")

# mp4 to gif
# ffmpeg -i galton.mp4 -filter_complex 'fps=30,scale=800:-1:flags=lanczos,split [o1] [o2];[o1] palettegen [p]; [o2] fifo [o3];[o3] [p] paletteuse' out.gif

# gifsicle -O99 -o out2.gif -k 16 out.gif
```





![](anim/inevitable.mp4)




